<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Legato Trainer v70 - Final Fix</title>
    <style>
        /* --- v70 STYLE --- */
        :root {
            --c-bg: #000000;
            --c-panel: #111111;
            --c-border: #333333;
            --c-text: #ffffff;
            --c-sub: #888888;
            --c-accent: #007bff;
            --c-good: #4cd964;
            --c-warn: #ffcc00;
            --c-bad: #ff3b30;
            --c-poor: #666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        body {
            font-family: "SF Mono", "Roboto Mono", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100dvh; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* HEADER */
        .header {
            padding: calc(5px + env(safe-area-inset-top)) 10px 5px 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--c-border);
            flex-shrink: 0; z-index: 10; background: var(--c-bg); height: 40px;
        }
        h1 { margin: 0; font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; color: #ccc; }
        .mode-select {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; outline: none; font-weight: bold;
        }

        /* METRONOME AREA */
        .metronome-area {
            flex-shrink: 0; height: 70px;
            background: radial-gradient(circle at center bottom, #1a1a1a, #000);
            border-bottom: 1px solid var(--c-border);
            position: relative; overflow: hidden;
        }
        .metro-arc {
            position: absolute; bottom: -40px; left: 50%; margin-left: -100px;
            width: 200px; height: 200px; border-top: 1px solid #333; border-radius: 50%; opacity: 0.5;
        }
        .bumper {
            position: absolute; top: 20px; width: 6px; height: 25px;
            background: #333; border: 1px solid #555; border-radius: 2px; z-index: 5;
        }
        .bumper-l { left: 25%; transform: rotate(15deg); }
        .bumper-r { right: 25%; transform: rotate(-15deg); }
        .bumper-flash {
            position: absolute; top: 10px; width: 30px; height: 40px;
            background: radial-gradient(circle, #fff 0%, transparent 70%);
            opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 20;
        }
        .flash-l { left: 20%; } .flash-r { right: 20%; }
        .hit-impact { animation: flashAnim 0.15s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: scale(1); } }

        .pendulum-pivot {
            width: 10px; height: 10px; background: #222; border: 2px solid #444; border-radius: 50%;
            position: absolute; bottom: -5px; left: 50%; margin-left: -5px; z-index: 10;
        }
        .pendulum-rod {
            width: 3px; height: 65px;
            background: linear-gradient(90deg, #444, #888, #444);
            position: absolute; bottom: 0; left: 50%; margin-left: -1.5px;
            transform-origin: bottom center; transform: rotate(40deg);
            will-change: transform; z-index: 8;
        }
        .pendulum-weight {
            width: 18px; height: 24px; background: linear-gradient(135deg, #333 0%, #111 100%);
            border: 2px solid var(--c-accent); border-radius: 4px;
            position: absolute; top: 10px; left: 50%; margin-left: -9px;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); z-index: 9;
        }

        /* STATUS */
        .status-bar {
            padding: 4px; background: #080808;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            border-bottom: 1px solid var(--c-border); flex-shrink: 0;
        }
        .star-row { display: flex; gap: 8px; font-size: 1.0rem; color: #333; }
        .star.active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.8); transform: scale(1.1); transition: transform 0.2s; }
        .progress-track { width: 100%; height: 3px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 2px;}
        .progress-fill { width: 0%; height: 100%; background: var(--c-accent); transition: width 0.1s linear; }
        .status-msg { 
            font-size: 0.65rem; color: var(--c-sub); height: 1.1em; margin-top: 1px; font-weight: bold; letter-spacing: 1px;
        }
        .blink { animation: pulse 1.5s infinite; color: #00d2ff; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* METRICS */
        .metrics-area {
            display: grid; grid-template-columns: 1fr 1.3fr; gap: 4px; padding: 4px; flex-shrink: 0;
        }
        .card {
            background: var(--c-panel); border: 1px solid var(--c-border); border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 6px 0; position: relative; transition: background 0.1s;
        }
        .card-lbl { font-size: 0.5rem; color: var(--c-sub); position: absolute; top: 4px; letter-spacing: 1px; }
        #cardTime .card-val { font-size: 1.2rem; font-weight: bold; line-height: 1; margin-top: 8px; color: #ccc; }
        #cardTime .card-sub { font-size: 0.6rem; font-weight: bold; margin-top: 2px; }
        #cardLegato .card-val { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-top: 6px; color: #fff; }
        #cardLegato .card-sub { font-size: 0.8rem; font-weight: bold; margin-top: 2px; }

        /* WAVE */
        .wave-area { padding: 0 4px 4px 4px; height: 20px; flex-shrink: 0; position: relative; }
        .canvas-wrapper {
            width: 100%; height: 100%; background: #000; border: 1px solid var(--c-border);
            border-radius: 4px; overflow: hidden; position: relative;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .input-led {
            position: absolute; top: 2px; right: 6px; width: 6px; height: 6px; border-radius: 50%;
            background: #222; border: 1px solid #444; transition: background 0.05s; z-index: 10;
        }
        .input-led.on { background: #00d2ff; box-shadow: 0 0 6px #00d2ff; border-color: #fff; }
        .input-led.noise { background: #ff3b30; box-shadow: 0 0 6px #ff3b30; animation: pulse 0.2s infinite; }

        /* HISTORY */
        .history-area {
            flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            border-top: 1px solid var(--c-border); background: #050505; position: relative; margin: 0;
        }
        .hist-table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; }
        .hist-table th { 
            text-align: left; padding: 4px 6px; color: var(--c-sub); font-size: 0.5rem; 
            position: sticky; top: 0; background: #111; z-index: 2; border-bottom: 1px solid var(--c-border);
        }
        .hist-table td { padding: 4px 6px; border-bottom: 1px solid #1a1a1a; vertical-align: middle; height: 28px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hist-new { background: rgba(0, 123, 255, 0.15); border-left: 3px solid var(--c-accent); animation: flashRow 0.5s; }
        .col-idx { width: 25px; color: #555; text-align: center; }
        .col-tim { width: 25%; text-align: left; color: #888; font-size: 0.6rem; }
        .col-dif { width: 15%; text-align: right; font-family: monospace; color: #666; }
        .col-leg { width: 25%; font-weight: 800; font-size: 0.7rem; text-align: right;}
        .col-scr { width: 15%; font-weight: bold; text-align: right; }

        /* SETTINGS */
        details { flex-shrink: 0; padding: 2px 10px; background: #080808; border-top: 1px solid #222; }
        summary { color: #555; font-size: 0.6rem; text-align: center; padding: 4px; cursor: pointer; list-style: none; }
        .settings-wrap { padding-bottom: 4px; display: flex; flex-direction: column; gap: 6px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #ccc; }
        .setting-row { display: flex; align-items: center; gap: 8px; flex-grow: 1; justify-content: flex-end; }
        input[type=range] { width: 90px; accent-color: var(--c-accent); }
        .btn-mini { padding: 4px 10px; border-radius: 15px; border: 1px solid #555; background: #333; color: #fff; font-size: 0.6rem; font-weight: bold; cursor: pointer; }
        .btn-adj { 
            padding: 0; width: 24px; height: 24px; border-radius: 4px; 
            border: 1px solid #444; background: #222; color: #fff; 
            font-size: 1.0rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-adj:active { background: #444; }
        
        .val-disp { font-family: monospace; color: var(--c-accent); width: 30px; text-align: right; font-size: 0.7rem; }

        /* CONTROLS */
        .controls-area {
            background: #000; border-top: 1px solid var(--c-border);
            display: flex; flex-direction: column;
            padding: 10px 10px calc(10px + var(--safe-bottom)) 10px;
            flex-shrink: 0; position: relative; gap: 10px;
        }
        .ctrl-row-main { display: flex; gap: 10px; width: 100%; }
        .bpm-box { background: #222; border-radius: 8px; width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bpm-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.0rem; font-weight: bold; padding: 0; }
        .bpm-lbl { font-size: 0.5rem; color: var(--c-sub); }
        .btn { 
            flex: 1; border: none; outline: none; box-shadow: none; border-radius: 8px; 
            font-size: 1.0rem; font-weight: bold; cursor: pointer; padding: 10px; letter-spacing: 1px; 
        }
        .btn-start { background: var(--c-accent); color: white; }
        .btn-stop { background: var(--c-bad); color: white; opacity: 0.3; pointer-events: none; }
        .btn-stop.active { opacity: 1; pointer-events: auto; }

        .credit {
            text-align: center; font-size: 0.5rem; line-height: 1.3; color: #444; 
            font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase;
            width: 100%; pointer-events: none;
        }

        /* OVERLAY */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            animation: fadeIn 0.3s; cursor: default;
        }
        .overlay h2 { font-size: 2.0rem; color: var(--c-warn); margin-bottom: 15px; text-align: center; }
        .overlay p { color: #ccc; margin-bottom: 30px; font-size: 0.8rem; text-align: center; line-height: 1.5; max-width: 80%; }
        .btn-calib-start {
            padding: 20px 40px; border-radius: 40px; border: none;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            background-color: #4cd964; color: #000;
            box-shadow: 0 0 25px rgba(76, 217, 100, 0.6); margin-bottom: 20px; -webkit-appearance: none;
        }
        .btn-calib-start:disabled { background-color: #555; color: #888; box-shadow: none; }
        .btn-restart { 
            padding: 15px 40px; border-radius: 30px; border: none; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            background: var(--c-accent); color: #fff; 
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); margin-top: 10px;
        }
        .btn-close {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: #333; border: 1px solid #555; color: #fff; font-size: 1.5rem; line-height: 40px; 
            text-align: center; cursor: pointer; z-index: 10000;
        }
        .skip-link { margin-top: 20px; color: #666; font-size: 0.7rem; text-decoration: underline; cursor: pointer; }
        .calib-progress { font-size: 3rem; font-weight: 800; color: #fff; margin-top: 20px; min-height: 40px; }
        
        .c-p { color: var(--c-good); } .c-g { color: var(--c-warn); } .c-b { color: var(--c-bad); } .c-poor { color: var(--c-poor); }
        .bg-p { background: rgba(76, 217, 100, 0.2); border-color: var(--c-good); }
        .bg-g { background: rgba(255, 204, 0, 0.2); border-color: var(--c-warn); }
        .bg-b { background: rgba(255, 59, 48, 0.2); border-color: var(--c-bad); }
        .bg-poor { background: rgba(153, 153, 153, 0.2); border-color: var(--c-poor); }
    </style>
</head>
<body>

<div class="header">
    <h1>LEGATO TRAINER v70</h1>
    <select id="grooveSelect" class="mode-select">
        <option value="1">Groove 1 (1/4)</option>
        <option value="2">Groove 2 (1/8)</option>
        <option value="3">Groove 3 (1/8 Triplet)</option>
        <option value="4">Groove 4 (Dotted)</option>
    </select>
</div>

<div class="metronome-area">
    <div class="metro-arc"></div>
    <div class="bumper bumper-l"></div><div class="bumper bumper-r"></div>
    <div id="flashL" class="bumper-flash flash-l"></div><div id="flashR" class="bumper-flash flash-r"></div>
    <div class="pendulum-pivot"></div>
    <div id="pendulumRod" class="pendulum-rod"><div class="pendulum-weight"></div></div>
</div>

<div class="status-bar">
    <div class="star-row">
        <span id="s1" class="star">★</span><span id="s2" class="star">★</span><span id="s3" class="star">★</span><span id="s4" class="star">★</span>
    </div>
    <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
    <div id="statusMsg" class="status-msg">READY</div>
</div>

<div class="metrics-area">
    <div id="cardTime" class="card">
        <span class="card-lbl">TIMING</span>
        <div id="valTime" class="card-val">--</div>
        <div id="subTime" class="card-sub">READY</div>
    </div>
    <div id="cardLegato" class="card">
        <span class="card-lbl">LEGATO</span>
        <div id="valLegato" class="card-val">--</div>
        <div id="subLegato" class="card-sub">--</div>
    </div>
</div>

<div class="wave-area">
    <div id="inputLed" class="input-led"></div>
    <div class="canvas-wrapper"><canvas id="scope"></canvas></div>
</div>

<div class="history-area">
    <table class="hist-table">
        <thead>
            <tr>
                <th class="col-idx">#</th>
                <th class="col-tim">TIMING</th>
                <th class="col-dif">DIFF</th>
                <th class="col-leg">LEGATO</th>
                <th class="col-scr">SCORE</th>
            </tr>
        </thead>
        <tbody id="histBody"></tbody>
    </table>
</div>

<details>
    <summary>SETTINGS ▼</summary>
    <div class="settings-wrap">
        <div class="setting-item"><span>Auto Calib</span> <button id="btnReCalib" class="btn-mini">RUN</button></div>
        <div class="setting-item">
            <span>Vol</span>
            <div class="setting-row">
                <button id="btnVolMinus" class="btn-adj">-</button>
                <input type="range" id="inVol" min="0" max="100" value="70">
                <button id="btnVolPlus" class="btn-adj">+</button>
            </div>
        </div>
        <div class="setting-item">
            <span>Sens</span>
            <div class="setting-row">
                <button id="btnSensMinus" class="btn-adj">-</button>
                <input type="range" id="inSens" min="1" max="50" value="10">
                <button id="btnSensPlus" class="btn-adj">+</button>
            </div>
        </div>
        <div class="setting-item">
            <span>Latency</span>
            <div class="setting-row">
                <span id="valLatDisp" class="val-disp">80</span>
                <button id="btnLatMinus" class="btn-adj">-</button>
                <input type="range" id="inLat" min="0" max="400" value="80">
                <button id="btnLatPlus" class="btn-adj">+</button>
            </div>
        </div>
    </div>
</details>

<div class="controls-area">
    <div class="ctrl-row-main">
        <div class="bpm-box">
            <input type="number" id="inBpm" class="bpm-input" value="90">
            <span class="bpm-lbl">BPM</span>
        </div>
        <button id="btnStart" class="btn btn-start">START</button>
        <button id="btnStop" class="btn btn-stop">STOP</button>
    </div>
    <div class="credit">
        Takeshi Ohbayashi presents<br>
        <span style="font-weight:normal; opacity:0.7">created by DONGURI Music & Arts</span>
    </div>
</div>

<div id="overlay" class="overlay" style="display:flex">
    <div id="btnCloseOverlay" class="btn-close">×</div>
    <h2 id="ovTitle">SETUP</h2>
    <p id="ovDesc">Set volume MAX & unmute.<br>Measuring Latency...</p>
    <button id="btnCalibStart" class="btn-calib-start">TAP TO START</button>
    <div id="calibCount" class="calib-progress"></div>
    <button id="btnRestart" class="btn-restart" style="display:none">CONTINUE</button>
    <div id="skipLink" class="skip-link">SKIP CALIBRATION</div>
</div>

<script>
const CONFIG = {
    PATTERNS: { 1: [1.0], 2: [0.5, 0.5], 3: [0.666, 0.333], 4: [0.75, 0.25] },
    THRESH_DEFAULT: 0.02, 
    LATENCY_DEFAULT: 0.080, // Safe Default 80ms
    CALIB_CLICKS: 8,
    NOISE_LIMIT: 180
};

const AudioSys = {
    ctx: null, mic: null, analyser: null, gain: null,
    
    async init() {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!this.ctx) this.ctx = new AC();
        if (this.ctx.state === 'suspended') await this.ctx.resume();
        
        if (!this.gain) {
            this.gain = this.ctx.createGain();
            this.gain.connect(this.ctx.destination);
        }
        
        if (!this.mic) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 0 }
                });
                this.mic = this.ctx.createMediaStreamSource(stream);
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 1024;
                this.mic.connect(this.analyser);
                return true;
            } catch(e) { alert("Mic Access Denied"); return false; }
        }
        return true;
    },

    playClick() {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        // SHARP NOISE BURST (Sawtooth) for clear attack detection
        osc.type = 'sawtooth';
        osc.frequency.value = 1000;
        g.gain.value = Game.vol;
        osc.connect(g); g.connect(this.gain);
        const now = this.ctx.currentTime;
        osc.start(now); osc.stop(now + 0.03);
        return now;
    },

    getRMS() {
        if(!this.analyser) return 0;
        const data = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteTimeDomainData(data);
        let sum = 0;
        for(let i=0; i<data.length; i++) { const x = (data[i]-128)/128.0; sum += x*x; }
        return Math.sqrt(sum / data.length);
    }
};

const View = {
    els: {
        pendulum: document.getElementById('pendulumRod'),
        flashL: document.getElementById('flashL'),
        flashR: document.getElementById('flashR'),
        inputLed: document.getElementById('inputLed'),
        msg: document.getElementById('statusMsg'),
        bar: document.getElementById('progressBar'),
        canvas: document.getElementById('scope'),
        ctx: document.getElementById('scope').getContext('2d'),
        valTime: document.getElementById('valTime'),
        subTime: document.getElementById('subTime'),
        cardTime: document.getElementById('cardTime'),
        valLeg: document.getElementById('valLegato'),
        subLeg: document.getElementById('subLegato'),
        cardLeg: document.getElementById('cardLegato'),
        hist: document.getElementById('histBody'),
        histArea: document.querySelector('.history-area'),
        overlay: document.getElementById('overlay'),
        ovTitle: document.getElementById('ovTitle'),
        ovDesc: document.getElementById('ovDesc'),
        calibBtn: document.getElementById('btnCalibStart'),
        restartBtn: document.getElementById('btnRestart'),
        skipLink: document.getElementById('skipLink'),
        calibCount: document.getElementById('calibCount'),
        closeOverlay: document.getElementById('btnCloseOverlay'),
        start: document.getElementById('btnStart'),
        stop: document.getElementById('btnStop'),
        inVol: document.getElementById('inVol'),
        inSens: document.getElementById('inSens'),
        inLat: document.getElementById('inLat'),
        valLatDisp: document.getElementById('valLatDisp'),
        inBpm: document.getElementById('inBpm'),
        groove: document.getElementById('grooveSelect'),
        btnVolMinus: document.getElementById('btnVolMinus'),
        btnVolPlus: document.getElementById('btnVolPlus'),
        btnSensMinus: document.getElementById('btnSensMinus'),
        btnSensPlus: document.getElementById('btnSensPlus'),
        btnLatMinus: document.getElementById('btnLatMinus'),
        btnLatPlus: document.getElementById('btnLatPlus')
    },
    visualScale: 600,
    init() { this.resize(); window.addEventListener('resize', () => this.resize()); },
    resize() { this.els.canvas.width = this.els.canvas.clientWidth; this.els.canvas.height = this.els.canvas.clientHeight; },
    updatePendulum(angle) { this.els.pendulum.style.transform = `rotate(${angle}deg)`; },
    triggerFlash(side) {
        this.els.flashL.classList.remove('hit-impact');
        this.els.flashR.classList.remove('hit-impact');
        void this.els.flashL.offsetWidth; 
        if(side === 'L') this.els.flashL.classList.add('hit-impact');
        else this.els.flashR.classList.add('hit-impact');
    },
    updateInputLed(isOn, isNoise) {
        if(isOn) this.els.inputLed.classList.add('on'); else this.els.inputLed.classList.remove('on');
        if(isNoise) {
            this.els.inputLed.classList.add('noise');
            this.els.msg.innerText = "NOISE! (RESET SENS)";
            this.els.msg.style.color = "#ff3b30";
        } else { this.els.inputLed.classList.remove('noise'); }
    },
    drawWave(rms, thresh, noteOn) {
        const w = this.els.canvas.width; const h = this.els.canvas.height;
        const ctx = this.els.ctx;
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
        const thY = h - (thresh * this.visualScale);
        const safeThY = Math.max(0, thY);
        ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
        ctx.strokeStyle = '#007bff'; ctx.lineWidth = 2; ctx.setLineDash([4,2]); 
        ctx.beginPath(); ctx.moveTo(0, safeThY); ctx.lineTo(w, safeThY); ctx.stroke();
        ctx.setLineDash([]); ctx.lineWidth = 1;
        const barH = Math.min(rms * this.visualScale, h);
        ctx.fillStyle = noteOn ? '#4cd964' : '#333';
        ctx.fillRect(w/2 - 20, h - barH, 40, barH);
    },
    renderResult(type, val, judge) {
        let col = "c-b";
        if(judge === "PERFECT" || judge === "EXCELLENT") col = "c-p";
        else if(judge === "GOOD" || judge === "OK") col = "c-g";
        else if(judge === "POOR") col = "c-poor";
        const cardVal = type === 'time' ? this.els.valTime : this.els.valLeg;
        const cardSub = type === 'time' ? this.els.subTime : this.els.subLeg;
        const cardBg = type === 'time' ? this.els.cardTime : this.els.cardLeg;
        let cls = "";
        if(judge === "PERFECT" || judge === "EXCELLENT") cls = "bg-p";
        else if(judge === "GOOD" || judge === "OK") cls = "bg-g";
        else cls = "bg-b";
        cardVal.innerText = val; cardSub.innerText = judge;
        cardSub.className = "card-sub " + col; cardBg.className = "card " + cls;
        setTimeout(() => cardBg.className = "card", 150);
    },
    addHistory(idx, legJudge, legPct, timJudge, diff) {
        const row = document.createElement('tr'); row.className = "hist-new";
        let lCol = "c-b"; if(legJudge==="EXCELLENT") lCol = "c-p"; else if(legJudge==="OK") lCol = "c-g";
        let tCol = "c-poor"; if(timJudge==="PERFECT") tCol = "c-p"; else if(timJudge==="GOOD") tCol = "c-g"; else if(!timJudge) timJudge = "MISS";
        row.innerHTML = `<td class="col-idx">${idx}</td><td class="col-tim ${tCol}">${timJudge}</td><td class="col-dif">${diff > 0 ? "+" + diff : diff}</td><td class="col-leg ${lCol}">${legJudge}</td><td class="col-scr">${legPct}%</td>`;
        if (this.els.hist.firstChild) this.els.hist.insertBefore(row, this.els.hist.firstChild); else this.els.hist.appendChild(row);
        this.els.histArea.scrollTop = 0;
        if (this.els.hist.children.length > 50) this.els.hist.lastChild.remove();
    },
    updateLatDisp(val) {
        this.els.valLatDisp.innerText = val;
    },
    resetGameUI() {
        this.els.bar.style.width = "0%";
        this.els.msg.innerText = "LISTEN... PLAY TO START";
        this.els.msg.style.color = "#00d2ff"; this.els.msg.classList.add('blink');
        this.els.valTime.innerText = "--"; this.els.subTime.innerText = "READY";
        this.els.valLeg.innerText = "--"; this.els.subLeg.innerText = "--";
        this.els.hist.innerHTML = "";
        this.els.stop.classList.remove('active');
        this.els.start.style.display = 'block';
    },
    showOverlay(mode, extraText) {
        this.els.overlay.style.display = 'flex';
        this.els.calibBtn.style.display = 'none';
        this.els.restartBtn.style.display = 'none';
        this.els.skipLink.style.display = 'none';
        this.els.calibCount.innerText = "";
        if (mode === 'calib') {
            this.els.ovTitle.innerText = "SETUP";
            this.els.ovDesc.innerHTML = "Set volume MAX & unmute.<br>Tap to calibrate.";
            this.els.calibBtn.style.display = 'block';
            this.els.calibBtn.innerText = "TAP TO START";
            this.els.calibBtn.disabled = false;
            this.els.skipLink.style.display = 'block';
        } else if (mode === 'clear') {
            this.els.ovTitle.innerText = "CLEAR!";
            this.els.ovDesc.innerText = "Excellent Rhythm & Control";
            this.els.restartBtn.innerText = "NEXT CHALLENGE";
            this.els.restartBtn.style.display = 'block';
        } else if (mode === 'result') {
            this.els.ovTitle.innerText = "DONE";
            this.els.ovDesc.innerHTML = extraText || "";
            this.els.restartBtn.innerText = "START GAME";
            this.els.restartBtn.style.display = 'block';
        }
    }
};

const Game = {
    running: false, calibrating: false, noteOn: false, noteStart: 0, lastHitId: -1, lastBeatIdx: -1, noiseCounter: 0,
    vol: 0.7, thresh: CONFIG.THRESH_DEFAULT, latency: CONFIG.LATENCY_DEFAULT, bpm: 90, pattern: 1,
    targetQueue: [], cycleHits: [], stars: 0, totalHits: 0, nextTime: 0, startTime: 0, beatCount: 0, pIndex: 0,
    calibHits: [],

    async startCalibration(e) {
        if(e) e.stopPropagation();
        View.els.calibBtn.innerText = "Starting...";
        const ready = await AudioSys.init();
        if(!ready) { View.els.calibBtn.innerText = "Mic Error"; return; }

        this.calibrating = true; this.running = false; this.calibHits = [];
        View.els.calibBtn.style.display = 'none'; View.els.skipLink.style.display = 'none';
        View.els.ovTitle.innerText = "CALIBRATING"; View.els.ovDesc.innerText = "Listening..."; View.els.calibCount.innerText = "READY";

        setTimeout(() => {
            let count = 0;
            const interval = setInterval(() => {
                count++;
                View.els.calibCount.innerText = count + "/" + CONFIG.CALIB_CLICKS;
                const sentTime = AudioSys.playClick();
                this.calibHits.push({ send: sentTime, recv: null });
                if (count >= CONFIG.CALIB_CLICKS) {
                    clearInterval(interval); setTimeout(() => this.finishCalibration(), 800);
                }
            }, 800);
            requestAnimationFrame(() => this.calibLoop());
        }, 500);
    },
    
    calibLoop() {
        if(!this.calibrating) return;
        const rms = AudioSys.getRMS();
        // EXTREMELY SENSITIVE (0.005) to detect iPhone Speaker
        if (rms > 0.005) {
            const now = AudioSys.ctx.currentTime;
            const hit = this.calibHits[this.calibHits.length-1];
            if(hit && !hit.recv && (now - hit.send < 0.5)) { hit.recv = now; }
        }
        requestAnimationFrame(() => this.calibLoop());
    },
    
    finishCalibration() {
        this.calibrating = false;
        let count = 0;
        let minLat = Infinity; 
        
        // Discard first 2 hits
        const validHits = this.calibHits.slice(2);
        validHits.forEach(h => {
            if(h.recv) { 
                const lat = h.recv - h.send;
                if (lat < minLat) minLat = lat;
                count++; 
            }
        });
        
        // Factor: 0.4 (approx 40% of measured loopback is actual system latency)
        const FACTOR = 0.4;
        let result = 0.080; 
        let msg = "Check volume. Using default 80ms.";
        
        if (count > 0) {
            result = minLat * FACTOR;
            if(result < 0.01) result = 0.01; 
            if(result > 0.5) result = 0.5;
            msg = `Latency: ${Math.round(result*1000)}ms<br>Correction Applied.`;
        }
        
        this.latency = result;
        const latMs = Math.round(result * 1000);
        View.els.inLat.value = latMs;
        View.updateLatDisp(latMs);
        
        View.showOverlay('result', msg);
    },
    
    startGame() {
        View.resetGameUI();
        this.running = true; this.stars = 0; this.totalHits = 0; this.beatCount = 0; this.pIndex = 0;
        this.targetQueue = []; this.cycleHits = []; this.noteOn = false;
        this.nextTime = AudioSys.ctx.currentTime + 0.1; this.startTime = this.nextTime; this.lastBeatIdx = -1;
        View.els.start.style.display = 'none'; View.els.stop.classList.add('active');
        this.scheduler(); this.gameLoop();
    },
    stopGame() {
        this.running = false; View.els.stop.classList.remove('active'); View.els.start.style.display = 'block'; View.els.msg.classList.remove('blink');
    },
    scheduler() {
        while (this.nextTime < AudioSys.ctx.currentTime + 0.1) {
            this.scheduleNote(this.nextTime);
            const pat = CONFIG.PATTERNS[this.pattern]; const secs = 60.0 / this.bpm;
            this.nextTime += secs * pat[this.pIndex];
            this.pIndex++;
            if (this.pIndex >= pat.length) { this.pIndex = 0; this.beatCount++; this.checkProgress(); }
        }
        if (this.running) setTimeout(() => this.scheduler(), 25);
    },
    scheduleNote(time) {
        const osc = AudioSys.ctx.createOscillator(); const g = AudioSys.ctx.createGain();
        const isDown = (this.beatCount % 4 === 0) && (this.pIndex === 0);
        osc.frequency.value = isDown ? 1500 : (this.pIndex === 0 ? 1000 : 600);
        g.gain.value = this.vol;
        osc.connect(g); g.connect(AudioSys.gain);
        osc.start(time); osc.stop(time + 0.04);
        const pat = CONFIG.PATTERNS[this.pattern]; const dur = (60 / this.bpm) * pat[this.pIndex];
        this.targetQueue = this.targetQueue.filter(t => t.time > AudioSys.ctx.currentTime - 1.0);
        this.targetQueue.push({ id: Date.now() + Math.random(), time: time, duration: dur, hit: false });
    },
    gameLoop() {
        if(this.calibrating) return;
        if(!this.running) { View.updatePendulum(40); return; }
        const now = AudioSys.ctx.currentTime; const rms = AudioSys.getRMS();
        const beatDur = 60.0 / this.bpm; const elapsed = now - this.startTime;
        if(elapsed >= 0) {
            const rad = (elapsed * Math.PI) / beatDur;
            View.updatePendulum(Math.cos(rad) * 40);
            const curBeat = Math.floor((elapsed + 0.05) / beatDur);
            if(curBeat > this.lastBeatIdx) {
                this.lastBeatIdx = curBeat;
                View.triggerFlash(curBeat % 2 === 0 ? 'R' : 'L');
            }
        }
        if(rms > this.thresh) { View.updateInputLed(true, false); this.noiseCounter++; } 
        else { View.updateInputLed(false, false); this.noiseCounter = 0; }
        if(this.noiseCounter > CONFIG.NOISE_LIMIT) View.updateInputLed(true, true);
        if(!this.noteOn && rms > this.thresh) {
            if(now - this.noteStart > 0.05) {
                this.noteOn = true; this.noteStart = now;
                if(!this.gameActive) { this.gameActive = true; View.els.msg.innerText = "COLLECT 4 STARS"; View.els.msg.classList.remove('blink'); View.els.msg.style.color = "#888"; this.beatCount = 0; }
                this.processHit(now);
            }
        }
        if(this.noteOn && rms < (this.thresh * 0.6)) { this.noteOn = false; this.processRelease(now); }
        View.drawWave(rms, this.thresh, this.noteOn);
        requestAnimationFrame(() => this.gameLoop());
    },
    processHit(time) {
        if(!this.gameActive) return;
        const corrected = time - this.latency;
        let best = null; let min = Infinity;
        this.targetQueue.forEach(t => {
            const d = Math.abs(corrected - t.time);
            if(d < min && !t.hit) { min = d; best = t; }
        });
        if(best && min < 0.25) {
            best.hit = true; this.lastHitId = best.id; best.actualStart = this.noteStart;
            const diffMs = Math.round((corrected - best.time) * 1000);
            let judge = "LATE"; if(diffMs < 0) judge = "EARLY";
            if(Math.abs(diffMs) <= 45) judge = "PERFECT"; else if(Math.abs(diffMs) <= 100) judge = "GOOD";
            View.renderResult('time', (diffMs>0?"+":"")+diffMs, judge); best.lastJudge = judge; 
        } else if (best && min < 0.35) { View.renderResult('time', Math.round((corrected - best.time) * 1000), "POOR"); }
    },
    processRelease(time) {
        const t = this.targetQueue.find(q => q.id === this.lastHitId);
        if(t && !t.processed) {
            const dur = time - t.actualStart; let pct = Math.round((dur / t.duration) * 100);
            if(pct > 100) pct = 100; if(dur < 0.03) return;
            t.processed = true; let judge = "SHORT"; if(pct >= 85) judge = "EXCELLENT"; else if(pct >= 60) judge = "OK";
            View.renderResult('legato', pct+"%", judge);
            this.cycleHits.push({ t: t.lastDiff, l: pct }); this.totalHits++;
            const diffMs = t.lastJudge ? Math.round((t.actualStart - this.latency - t.time) * 1000) : "--";
            View.addHistory(this.totalHits, judge, pct, t.lastJudge || "MISS", diffMs);
        }
    },
    checkProgress() {
        const cycle = this.beatCount % 16; const pct = (cycle / 16) * 100;
        View.els.bar.style.width = pct + "%";
        if(cycle === 0 && this.beatCount > 0) {
            const hits = this.cycleHits.length;
            if(hits < 4) { View.els.msg.innerText = "PLAY MORE NOTES!"; View.els.msg.style.color = "#666"; } 
            else {
                let avgL = this.cycleHits.reduce((a,b)=>a+b.l, 0) / hits;
                if(avgL >= 75) { this.stars++; View.els.msg.innerText = "GREAT! STAR GET!"; View.els.msg.style.color = "#ffd700"; this.updateStars(); } 
                else { View.els.msg.innerText = `TRY AGAIN (Avg: ${Math.round(avgL)}%)`; View.els.msg.style.color = "#ff3b30"; }
            }
            this.cycleHits = []; setTimeout(() => View.els.bar.style.width = "0%", 500);
        }
    },
    updateStars() {
        for(let i=0; i<4; i++) {
            if(i < this.stars) View.els.stars[i].classList.add('active');
            else View.els.stars[i].classList.remove('active');
        }
        if(this.stars >= 4) { this.running = false; this.stopGame(); View.showOverlay('clear'); }
    }
};

// --- BINDINGS ---
View.init();
View.els.inVol.value = Game.vol * 100;
View.els.inSens.value = Game.thresh * 500;
View.els.inLat.value = Game.latency * 1000;
View.updateLatDisp(Math.round(Game.latency * 1000));

View.els.inVol.addEventListener('input', e => { Game.vol = e.target.value/100 || 0.0001; if(AudioSys.gain) AudioSys.gain.gain.value = Game.vol; });
View.els.inSens.addEventListener('input', e => Game.thresh = e.target.value/500);
View.els.inLat.addEventListener('input', e => {
    Game.latency = e.target.value/1000;
    View.updateLatDisp(e.target.value);
});
View.els.inBpm.addEventListener('change', e => Game.bpm = parseInt(e.target.value));
View.els.groove.addEventListener('change', e => { Game.pattern = parseInt(e.target.value); Game.pIndex = 0; });

View.els.btnVolMinus.addEventListener('click', () => { let val = parseInt(View.els.inVol.value)-5; if(val<0)val=0; View.els.inVol.value=val; Game.vol=val/100||0.0001; if(AudioSys.gain)AudioSys.gain.gain.value=Game.vol; });
View.els.btnVolPlus.addEventListener('click', () => { let val = parseInt(View.els.inVol.value)+5; if(val>100)val=100; View.els.inVol.value=val; Game.vol=val/100; if(AudioSys.gain)AudioSys.gain.gain.value=Game.vol; });
View.els.btnSensMinus.addEventListener('click', () => { let val = parseInt(View.els.inSens.value)-1; if(val<1)val=1; View.els.inSens.value=val; Game.thresh=val/500; });
View.els.btnSensPlus.addEventListener('click', () => { let val = parseInt(View.els.inSens.value)+1; if(val>50)val=50; View.els.inSens.value=val; Game.thresh=val/500; });
View.els.btnLatMinus.addEventListener('click', () => { 
    let val = parseInt(View.els.inLat.value)-5; if(val<0)val=0; 
    View.els.inLat.value=val; View.updateLatDisp(val); Game.latency=val/1000; 
});
View.els.btnLatPlus.addEventListener('click', () => { 
    let val = parseInt(View.els.inLat.value)+5; if(val>400)val=400; 
    View.els.inLat.value=val; View.updateLatDisp(val); Game.latency=val/1000; 
});

View.els.calibBtn.addEventListener('click', e => Game.startCalibration(e));
View.els.skipLink.addEventListener('click', async e => { e.stopPropagation(); const ready = await AudioSys.init(); if(ready) { View.els.overlay.style.display = 'none'; Game.startGame(); }});
View.els.start.addEventListener('click', async () => { const ready = await AudioSys.init(); if(ready) Game.startGame(); });
View.els.stop.addEventListener('click', () => Game.stopGame());
View.els.restartBtn.addEventListener('click', (e) => { 
    e.stopPropagation(); View.els.overlay.style.display = 'none'; 
    if(View.els.restartBtn.innerText === "START GAME") Game.startGame();
    else View.resetGameUI(); 
});
document.getElementById('btnReCalib').addEventListener('click', () => { Game.stopGame(); View.showOverlay('calib'); });
document.getElementById('btnCloseOverlay').addEventListener('click', (e) => { e.stopPropagation(); View.els.overlay.style.display = 'none'; Game.calibrating = false; View.resetGameUI(); });
View.els.overlay.addEventListener('click', e => {
    if(Game.calibrating) return;
    if(e.target.tagName === "BUTTON") return;
    if(View.els.restartBtn.style.display === 'block') { View.els.overlay.style.display = 'none'; View.resetGameUI(); }
});
</script>
</body>
</html>
