<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.2">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="apple-mobile-web-app-capable" content="yes"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Legato Trainer v71 - Visual Confirmation&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* --- v71 STYLE --- */</p>
<p class="p1"><span class="Apple-converted-space">        </span>:root {</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-bg: #000000;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-panel: #111111;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-border: #333333;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-text: #ffffff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-sub: #888888;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-accent: #007bff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-good: #4cd964;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-warn: #ffcc00;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-bad: #ff3b30;</p>
<p class="p1"><span class="Apple-converted-space">            </span>--c-poor: #666;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: "SF Mono", "Roboto Mono", -apple-system, BlinkMacSystemFont, sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: var(--c-bg);</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: var(--c-text);</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin: 0; padding: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100dvh; overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>user-select: none; -webkit-user-select: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* HEADER */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.header {</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: calc(5px + env(safe-area-inset-top)) 10px 5px 10px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; justify-content: space-between; align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-shrink: 0; z-index: 10; background: var(--c-bg); height: 40px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>h1 { margin: 0; font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; color: #ccc; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.mode-select {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #222; color: #fff; border: 1px solid #444;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; outline: none; font-weight: bold;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* METRONOME AREA */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.metronome-area {</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-shrink: 0; height: 70px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: radial-gradient(circle at center bottom, #1a1a1a, #000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: relative; overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.metro-arc {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: -40px; left: 50%; margin-left: -100px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 200px; height: 200px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-top: 1px solid #333; border-radius: 50%; opacity: 0.5;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 20px; width: 6px; height: 25px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #333; border: 1px solid #555; border-radius: 2px; z-index: 5;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-l { left: 25%; transform: rotate(15deg); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-r { right: 25%; transform: rotate(-15deg); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bumper-flash {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 10px; width: 30px; height: 40px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: radial-gradient(circle, #fff 0%, transparent 70%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>opacity: 0; pointer-events: none; mix-blend-mode: screen; z-index: 20;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.flash-l { left: 20%; } .flash-r { right: 20%; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hit-impact { animation: flashAnim 0.15s ease-out; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes flashAnim { 0% { opacity: 1; transform: scale(1.5); } 100% { opacity: 0; transform: scale(1); } }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-pivot {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 10px; height: 10px; background: #222; border: 2px solid #444; border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: -5px; left: 50%; margin-left: -5px; z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-rod {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 3px; height: 65px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: linear-gradient(90deg, #444, #888, #444);</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; bottom: 0; left: 50%; margin-left: -1.5px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform-origin: bottom center; transform: rotate(40deg);</p>
<p class="p1"><span class="Apple-converted-space">            </span>will-change: transform; z-index: 8;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.pendulum-weight {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 18px; height: 24px; background: linear-gradient(135deg, #333 0%, #111 100%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid var(--c-accent); border-radius: 4px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 10px; left: 50%; margin-left: -9px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); z-index: 9;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* STATUS */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.status-bar {</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 4px; background: #080808;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; align-items: center; gap: 2px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-bottom: 1px solid var(--c-border); flex-shrink: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.star-row { display: flex; gap: 8px; font-size: 1.0rem; color: #333; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.star.active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.8); transform: scale(1.1); transition: transform 0.2s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-track { width: 100%; height: 3px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 2px;}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.progress-fill { width: 0%; height: 100%; background: var(--c-accent); transition: width 0.1s linear; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.status-msg {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 0.65rem; color: var(--c-sub); height: 1.1em; margin-top: 1px; font-weight: bold; letter-spacing: 1px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.blink { animation: pulse 1.5s infinite; color: #00d2ff; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>@keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* METRICS */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.metrics-area {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: grid; grid-template-columns: 1fr 1.3fr; gap: 4px; padding: 4px; flex-shrink: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: var(--c-panel); border: 1px solid var(--c-border); border-radius: 6px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; justify-content: center; align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 6px 0; position: relative; transition: background 0.1s;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.card-lbl { font-size: 0.5rem; color: var(--c-sub); position: absolute; top: 4px; letter-spacing: 1px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#cardTime .card-val { font-size: 1.2rem; font-weight: bold; line-height: 1; margin-top: 8px; color: #ccc; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#cardTime .card-sub { font-size: 0.6rem; font-weight: bold; margin-top: 2px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#cardLegato .card-val { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-top: 6px; color: #fff; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#cardLegato .card-sub { font-size: 0.8rem; font-weight: bold; margin-top: 2px; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* WAVE */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.wave-area { padding: 0 4px 4px 4px; height: 20px; flex-shrink: 0; position: relative; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.canvas-wrapper {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%; height: 100%; background: #000; border: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 4px; overflow: hidden; position: relative;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>canvas { display: block; width: 100%; height: 100%; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 2px; right: 6px; width: 6px; height: 6px; border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #222; border: 1px solid #444; transition: background 0.05s; z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led.on { background: #00d2ff; box-shadow: 0 0 6px #00d2ff; border-color: #fff; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.input-led.noise { background: #ff3b30; box-shadow: 0 0 6px #ff3b30; animation: pulse 0.2s infinite; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* HISTORY */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.history-area {</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-top: 1px solid var(--c-border); background: #050505; position: relative; margin: 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table th {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: left; padding: 4px 6px; color: var(--c-sub); font-size: 0.5rem;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>position: sticky; top: 0; background: #111; z-index: 2; border-bottom: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-table td { padding: 4px 6px; border-bottom: 1px solid #1a1a1a; vertical-align: middle; height: 28px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hist-new { background: rgba(0, 123, 255, 0.15); border-left: 3px solid var(--c-accent); animation: flashRow 0.5s; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.col-idx { width: 25px; color: #555; text-align: center; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.col-tim { width: 25%; text-align: left; color: #888; font-size: 0.6rem; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.col-dif { width: 15%; text-align: right; font-family: monospace; color: #666; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.col-leg { width: 25%; font-weight: 800; font-size: 0.7rem; text-align: right;}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.col-scr { width: 15%; font-weight: bold; text-align: right; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* SETTINGS */</p>
<p class="p1"><span class="Apple-converted-space">        </span>details { flex-shrink: 0; padding: 2px 10px; background: #080808; border-top: 1px solid #222; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>summary { color: #555; font-size: 0.6rem; text-align: center; padding: 4px; cursor: pointer; list-style: none; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.settings-wrap { padding-bottom: 4px; display: flex; flex-direction: column; gap: 6px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.setting-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #ccc; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.setting-row { display: flex; align-items: center; gap: 8px; flex-grow: 1; justify-content: flex-end; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>input[type=range] { width: 90px; accent-color: var(--c-accent); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-mini { padding: 4px 10px; border-radius: 15px; border: 1px solid #555; background: #333; color: #fff; font-size: 0.6rem; font-weight: bold; cursor: pointer; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-adj {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 0; width: 24px; height: 24px; border-radius: 4px;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 1px solid #444; background: #222; color: #fff;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.0rem; font-weight: bold; cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; align-items: center; justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-adj:active { background: #444; }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Small Value display for Latency */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.val-disp { font-family: monospace; color: var(--c-accent); width: 30px; text-align: right; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* CONTROLS */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.controls-area {</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #000; border-top: 1px solid var(--c-border);</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; /* Stacked */</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 10px 10px calc(10px + var(--safe-bottom)) 10px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>flex-shrink: 0; position: relative; gap: 10px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.ctrl-row-main { display: flex; gap: 10px; width: 100%; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-box { background: #222; border-radius: 8px; width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.0rem; font-weight: bold; padding: 0; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bpm-lbl { font-size: 0.5rem; color: var(--c-sub); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>flex: 1; border: none; outline: none; box-shadow: none; border-radius: 8px;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.0rem; font-weight: bold; cursor: pointer; padding: 12px; letter-spacing: 1px;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-start { background: var(--c-accent); color: white; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-stop { background: var(--c-bad); color: white; opacity: 0.3; pointer-events: none; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-stop.active { opacity: 1; pointer-events: auto; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.credit {</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center; font-size: 0.5rem; line-height: 1.3; color: #444;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%; pointer-events: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* OVERLAY */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 0; left: 0; width: 100%; height: 100%;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>background: rgba(0,0,0,0.98); z-index: 9999;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex; flex-direction: column; justify-content: center; align-items: center;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>animation: fadeIn 0.3s; cursor: default;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay h2 { font-size: 2.0rem; color: var(--c-warn); margin-bottom: 15px; text-align: center; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.overlay p { color: #ccc; margin-bottom: 30px; font-size: 0.8rem; text-align: center; line-height: 1.5; max-width: 80%; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-calib-start {</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 20px 40px; border-radius: 40px; border: none;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.2rem; font-weight: 800; cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #4cd964; color: #000;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 25px rgba(76, 217, 100, 0.6); margin-bottom: 20px; -webkit-appearance: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-calib-start:disabled { background-color: #555; color: #888; box-shadow: none; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-restart {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 15px 40px; border-radius: 30px; border: none;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.2rem; font-weight: bold; cursor: pointer;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>background: var(--c-accent); color: #fff;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); margin-top: 10px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.btn-close {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: #333; border: 1px solid #555; color: #fff; font-size: 1.5rem; line-height: 40px;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center; cursor: pointer; z-index: 10000;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.skip-link { margin-top: 20px; color: #666; font-size: 0.7rem; text-decoration: underline; cursor: pointer; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.calib-progress { font-size: 3rem; font-weight: 800; color: #fff; margin-top: 20px; min-height: 40px; }</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>.c-p { color: var(--c-good); } .c-g { color: var(--c-warn); } .c-b { color: var(--c-bad); } .c-poor { color: var(--c-poor); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-p { background: rgba(76, 217, 100, 0.2); border-color: var(--c-good); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-g { background: rgba(255, 204, 0, 0.2); border-color: var(--c-warn); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-b { background: rgba(255, 59, 48, 0.2); border-color: var(--c-bad); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.bg-poor { background: rgba(153, 153, 153, 0.2); border-color: var(--c-poor); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="header"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h1&gt;LEGATO TRAINER v69&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;select id="grooveSelect" class="mode-select"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="1"&gt;Groove 1 (1/4)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="2"&gt;Groove 2 (1/8)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="3"&gt;Groove 3 (1/8 Triplet)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;option value="4"&gt;Groove 4 (Dotted)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/select&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="metronome-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="metro-arc"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="bumper bumper-l"&gt;&lt;/div&gt;&lt;div class="bumper bumper-r"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="flashL" class="bumper-flash flash-l"&gt;&lt;/div&gt;&lt;div id="flashR" class="bumper-flash flash-r"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="pendulum-pivot"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="pendulumRod" class="pendulum-rod"&gt;&lt;div class="pendulum-weight"&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="status-bar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="star-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span id="s1" class="star"&gt;★&lt;/span&gt;&lt;span id="s2" class="star"&gt;★&lt;/span&gt;&lt;span id="s3" class="star"&gt;★&lt;/span&gt;&lt;span id="s4" class="star"&gt;★&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="progress-track"&gt;&lt;div id="progressBar" class="progress-fill"&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="statusMsg" class="status-msg"&gt;READY&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="metrics-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="cardTime" class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="card-lbl"&gt;TIMING&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="valTime" class="card-val"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="subTime" class="card-sub"&gt;READY&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="cardLegato" class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="card-lbl"&gt;LEGATO&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="valLegato" class="card-val"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="subLegato" class="card-sub"&gt;--&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="wave-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="inputLed" class="input-led"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="canvas-wrapper"&gt;&lt;canvas id="scope"&gt;&lt;/canvas&gt;&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="history-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;table class="hist-table"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th class="col-idx"&gt;#&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th class="col-tim"&gt;TIMING&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th class="col-dif"&gt;DIFF&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th class="col-leg"&gt;LEGATO&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;th class="col-scr"&gt;SCORE&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;tbody id="histBody"&gt;&lt;/tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/table&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;details&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;summary&gt;SETTINGS ▼&lt;/summary&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="settings-wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;&lt;span&gt;Auto Calib&lt;/span&gt; &lt;button id="btnReCalib" class="btn-mini"&gt;RUN&lt;/button&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;span&gt;Vol&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="setting-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnVolMinus" class="btn-adj"&gt;-&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="range" id="inVol" min="0" max="100" value="70"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnVolPlus" class="btn-adj"&gt;+&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;span&gt;Sens&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="setting-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnSensMinus" class="btn-adj"&gt;-&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="range" id="inSens" min="1" max="50" value="10"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnSensPlus" class="btn-adj"&gt;+&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="setting-item"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;span&gt;Latency&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="setting-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;span id="valLatDisp" class="val-disp"&gt;80&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnLatMinus" class="btn-adj"&gt;-&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;input type="range" id="inLat" min="0" max="400" value="80"&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;button id="btnLatPlus" class="btn-adj"&gt;+&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/details&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div class="controls-area"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="ctrl-row-main"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="bpm-box"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;input type="number" id="inBpm" class="bpm-input" value="90"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;span class="bpm-lbl"&gt;BPM&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btnStart" class="btn btn-start"&gt;START&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btnStop" class="btn btn-stop"&gt;STOP&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="credit"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>Takeshi Ohbayashi presents&lt;br&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span style="font-weight:normal; opacity:0.7"&gt;created by DONGURI Music &amp; Arts&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;div id="overlay" class="overlay" style="display:flex"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="btnCloseOverlay" class="btn-close"&gt;×&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h2 id="ovTitle"&gt;SETUP&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;p id="ovDesc"&gt;Set volume MAX &amp; unmute.&lt;br&gt;Measuring Latency...&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="btnCalibStart" class="btn-calib-start"&gt;TAP TO START&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="calibCount" class="calib-progress"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="btnRestart" class="btn-restart" style="display:none"&gt;CONTINUE&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="skipLink" class="skip-link"&gt;SKIP CALIBRATION&lt;/div&gt;</p>
<p class="p1">&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">const CONFIG = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>PATTERNS: { 1: [1.0], 2: [0.5, 0.5], 3: [0.666, 0.333], 4: [0.75, 0.25] },</p>
<p class="p1"><span class="Apple-converted-space">    </span>THRESH_DEFAULT: 0.02,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>LATENCY_DEFAULT: 0.080, // 80ms as safer default for iPhone</p>
<p class="p1"><span class="Apple-converted-space">    </span>CALIB_CLICKS: 8,</p>
<p class="p1"><span class="Apple-converted-space">    </span>NOISE_LIMIT: 180</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">const AudioSys = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctx: null, mic: null, analyser: null, gain: null,</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>async init() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const AC = window.AudioContext || window.webkitAudioContext;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!this.ctx) this.ctx = new AC();</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (this.ctx.state === 'suspended') await this.ctx.resume();</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!this.gain) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.gain = this.ctx.createGain();</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.gain.connect(this.ctx.destination);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!this.mic) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const stream = await navigator.mediaDevices.getUserMedia({<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                    </span>audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 0 }</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.mic = this.ctx.createMediaStreamSource(stream);</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.analyser = this.ctx.createAnalyser();</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.analyser.fftSize = 1024;</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.mic.connect(this.analyser);</p>
<p class="p1"><span class="Apple-converted-space">                </span>return true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch(e) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert("Mic access needed.");</p>
<p class="p1"><span class="Apple-converted-space">                </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>return true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>playClick() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.ctx) return;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const osc = this.ctx.createOscillator();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const g = this.ctx.createGain();</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Noise Burst for calibration</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.type = 'sawtooth';</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.frequency.value = 800;</p>
<p class="p1"><span class="Apple-converted-space">        </span>g.gain.value = Game.vol;</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.connect(g); g.connect(this.gain);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const now = this.ctx.currentTime;</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.start(now); osc.stop(now + 0.03);</p>
<p class="p1"><span class="Apple-converted-space">        </span>return now;</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>getRMS() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.analyser) return 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const data = new Uint8Array(this.analyser.frequencyBinCount);</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.analyser.getByteTimeDomainData(data);</p>
<p class="p1"><span class="Apple-converted-space">        </span>let sum = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>for(let i=0; i&lt;data.length; i++) { const x = (data[i]-128)/128.0; sum += x*x; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>return Math.sqrt(sum / data.length);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">const View = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>els: {</p>
<p class="p1"><span class="Apple-converted-space">        </span>pendulum: document.getElementById('pendulumRod'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>flashL: document.getElementById('flashL'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>flashR: document.getElementById('flashR'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>inputLed: document.getElementById('inputLed'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>msg: document.getElementById('statusMsg'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>bar: document.getElementById('progressBar'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>canvas: document.getElementById('scope'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx: document.getElementById('scope').getContext('2d'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>valTime: document.getElementById('valTime'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>subTime: document.getElementById('subTime'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>cardTime: document.getElementById('cardTime'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>valLeg: document.getElementById('valLegato'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>subLeg: document.getElementById('subLegato'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>cardLeg: document.getElementById('cardLegato'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>hist: document.getElementById('histBody'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>histArea: document.querySelector('.history-area'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>overlay: document.getElementById('overlay'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>ovTitle: document.getElementById('ovTitle'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>ovDesc: document.getElementById('ovDesc'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>calibBtn: document.getElementById('btnCalibStart'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>restartBtn: document.getElementById('btnRestart'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>skipLink: document.getElementById('skipLink'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>calibCount: document.getElementById('calibCount'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>closeOverlay: document.getElementById('btnCloseOverlay'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>start: document.getElementById('btnStart'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>stop: document.getElementById('btnStop'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>inVol: document.getElementById('inVol'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>inSens: document.getElementById('inSens'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>inLat: document.getElementById('inLat'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>valLatDisp: document.getElementById('valLatDisp'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>inBpm: document.getElementById('inBpm'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>groove: document.getElementById('grooveSelect'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnVolMinus: document.getElementById('btnVolMinus'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnVolPlus: document.getElementById('btnVolPlus'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnSensMinus: document.getElementById('btnSensMinus'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnSensPlus: document.getElementById('btnSensPlus'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnLatMinus: document.getElementById('btnLatMinus'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>btnLatPlus: document.getElementById('btnLatPlus')</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>visualScale: 600,</p>
<p class="p1"><span class="Apple-converted-space">    </span>init() { this.resize(); window.addEventListener('resize', () =&gt; this.resize()); },</p>
<p class="p1"><span class="Apple-converted-space">    </span>resize() { this.els.canvas.width = this.els.canvas.clientWidth; this.els.canvas.height = this.els.canvas.clientHeight; },</p>
<p class="p1"><span class="Apple-converted-space">    </span>updatePendulum(angle) { this.els.pendulum.style.transform = `rotate(${angle}deg)`; },</p>
<p class="p1"><span class="Apple-converted-space">    </span>triggerFlash(side) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.flashL.classList.remove('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.flashR.classList.remove('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">        </span>void this.els.flashL.offsetWidth;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if(side === 'L') this.els.flashL.classList.add('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">        </span>else this.els.flashR.classList.add('hit-impact');</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateInputLed(isOn, isNoise) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(isOn) this.els.inputLed.classList.add('on'); else this.els.inputLed.classList.remove('on');</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(isNoise) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.inputLed.classList.add('noise');</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.msg.innerText = "NOISE! (RESET SENS)";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.msg.style.color = "#ff3b30";</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else { this.els.inputLed.classList.remove('noise'); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>drawWave(rms, thresh, noteOn) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const w = this.els.canvas.width; const h = this.els.canvas.height;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const ctx = this.els.ctx;</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const thY = h - (thresh * this.visualScale);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const safeThY = Math.max(0, thY);</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.strokeStyle = '#007bff'; ctx.lineWidth = 2; ctx.setLineDash([4,2]);<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.beginPath(); ctx.moveTo(0, safeThY); ctx.lineTo(w, safeThY); ctx.stroke();</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.setLineDash([]); ctx.lineWidth = 1;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const barH = Math.min(rms * this.visualScale, h);</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.fillStyle = noteOn ? '#4cd964' : '#333';</p>
<p class="p1"><span class="Apple-converted-space">        </span>ctx.fillRect(w/2 - 20, h - barH, 40, barH);</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>renderResult(type, val, judge) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>let col = "c-b";</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(judge === "PERFECT" || judge === "EXCELLENT") col = "c-p";</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(judge === "GOOD" || judge === "OK") col = "c-g";</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(judge === "POOR") col = "c-poor";</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cardVal = type === 'time' ? this.els.valTime : this.els.valLeg;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cardSub = type === 'time' ? this.els.subTime : this.els.subLeg;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cardBg = type === 'time' ? this.els.cardTime : this.els.cardLeg;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let cls = "";</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(judge === "PERFECT" || judge === "EXCELLENT") cls = "bg-p";</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(judge === "GOOD" || judge === "OK") cls = "bg-g";</p>
<p class="p1"><span class="Apple-converted-space">        </span>else cls = "bg-b";</p>
<p class="p1"><span class="Apple-converted-space">        </span>cardVal.innerText = val; cardSub.innerText = judge;</p>
<p class="p1"><span class="Apple-converted-space">        </span>cardSub.className = "card-sub " + col; cardBg.className = "card " + cls;</p>
<p class="p1"><span class="Apple-converted-space">        </span>setTimeout(() =&gt; cardBg.className = "card", 150);</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>addHistory(idx, legJudge, legPct, timJudge, diff) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const row = document.createElement('tr'); row.className = "hist-new";</p>
<p class="p1"><span class="Apple-converted-space">        </span>let lCol = "c-b"; if(legJudge==="EXCELLENT") lCol = "c-p"; else if(legJudge==="OK") lCol = "c-g";</p>
<p class="p1"><span class="Apple-converted-space">        </span>let tCol = "c-poor"; if(timJudge==="PERFECT") tCol = "c-p"; else if(timJudge==="GOOD") tCol = "c-g"; else if(!timJudge) timJudge = "MISS";</p>
<p class="p1"><span class="Apple-converted-space">        </span>row.innerHTML = `&lt;td class="col-idx"&gt;${idx}&lt;/td&gt;&lt;td class="col-tim ${tCol}"&gt;${timJudge}&lt;/td&gt;&lt;td class="col-dif"&gt;${diff &gt; 0 ? "+" + diff : diff}&lt;/td&gt;&lt;td class="col-leg ${lCol}"&gt;${legJudge}&lt;/td&gt;&lt;td class="col-scr"&gt;${legPct}%&lt;/td&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (this.els.hist.firstChild) this.els.hist.insertBefore(row, this.els.hist.firstChild); else this.els.hist.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.histArea.scrollTop = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (this.els.hist.children.length &gt; 50) this.els.hist.lastChild.remove();</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateLatDisp(val) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.valLatDisp.innerText = val;</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>resetGameUI() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.bar.style.width = "0%";</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.msg.innerText = "LISTEN... PLAY TO START";</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.msg.style.color = "#00d2ff"; this.els.msg.classList.add('blink');</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.valTime.innerText = "--"; this.els.subTime.innerText = "READY";</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.valLeg.innerText = "--"; this.els.subLeg.innerText = "--";</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.hist.innerHTML = "";</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.stop.classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.start.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>showOverlay(mode, extraText) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.overlay.style.display = 'flex';</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.calibBtn.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.restartBtn.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.skipLink.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.els.calibCount.innerText = "";</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (mode === 'calib') {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovTitle.innerText = "SETUP";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovDesc.innerHTML = "Set volume MAX &amp; unmute.&lt;br&gt;Tap to calibrate.";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.calibBtn.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.calibBtn.innerText = "TAP TO START";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.calibBtn.disabled = false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.skipLink.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (mode === 'clear') {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovTitle.innerText = "CLEAR!";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovDesc.innerText = "Excellent Rhythm &amp; Control";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.restartBtn.innerText = "NEXT CHALLENGE";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.restartBtn.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (mode === 'result') {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovTitle.innerText = "DONE";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.ovDesc.innerHTML = extraText || "";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.restartBtn.innerText = "START GAME";</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.els.restartBtn.style.display = 'block';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">const Game = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>running: false, calibrating: false, noteOn: false, noteStart: 0, lastHitId: -1, lastBeatIdx: -1, noiseCounter: 0,</p>
<p class="p1"><span class="Apple-converted-space">    </span>vol: 0.7, thresh: CONFIG.THRESH_DEFAULT, latency: CONFIG.LATENCY_DEFAULT, bpm: 90, pattern: 1,</p>
<p class="p1"><span class="Apple-converted-space">    </span>targetQueue: [], cycleHits: [], stars: 0, totalHits: 0, nextTime: 0, startTime: 0, beatCount: 0, pIndex: 0,</p>
<p class="p1"><span class="Apple-converted-space">    </span>calibHits: [],</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>async startCalibration(e) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(e) e.stopPropagation();</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.calibBtn.innerText = "Starting...";</p>
<p class="p1"><span class="Apple-converted-space">        </span>const ready = await AudioSys.init();</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!ready) { View.els.calibBtn.innerText = "Mic Error"; return; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>this.calibrating = true; this.running = false; this.calibHits = [];</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.calibBtn.style.display = 'none'; View.els.skipLink.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.ovTitle.innerText = "CALIBRATING"; View.els.ovDesc.innerText = "Listening..."; View.els.calibCount.innerText = "READY";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>let count = 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const interval = setInterval(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>count++;</p>
<p class="p1"><span class="Apple-converted-space">                </span>View.els.calibCount.innerText = count + "/" + CONFIG.CALIB_CLICKS;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const sentTime = AudioSys.playClick();</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.calibHits.push({ send: sentTime, recv: null });</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (count &gt;= CONFIG.CALIB_CLICKS) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>clearInterval(interval); setTimeout(() =&gt; this.finishCalibration(), 800);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}, 800);</p>
<p class="p1"><span class="Apple-converted-space">            </span>requestAnimationFrame(() =&gt; this.calibLoop());</p>
<p class="p1"><span class="Apple-converted-space">        </span>}, 500);</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>calibLoop() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.calibrating) return;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const rms = AudioSys.getRMS();</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Very sensitive detection for calibration (0.005)</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (rms &gt; 0.005) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const now = AudioSys.ctx.currentTime;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const hit = this.calibHits[this.calibHits.length-1];</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(hit &amp;&amp; !hit.recv &amp;&amp; (now - hit.send &lt; 0.5)) { hit.recv = now; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>requestAnimationFrame(() =&gt; this.calibLoop());</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>finishCalibration() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.calibrating = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let count = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let minLat = Infinity;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Discard first 2 hits</p>
<p class="p1"><span class="Apple-converted-space">        </span>const validHits = this.calibHits.slice(2);</p>
<p class="p1"><span class="Apple-converted-space">        </span>validHits.forEach(h =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(h.recv) {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>const lat = h.recv - h.send;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (lat &lt; minLat) minLat = lat;</p>
<p class="p1"><span class="Apple-converted-space">                </span>count++;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>let result = 0.080; // Default 80ms if failed</p>
<p class="p1"><span class="Apple-converted-space">        </span>let msg = "Calibration Failed.&lt;br&gt;Using default 80ms.";</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (count &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// FIX: USE 100% of Measured Minimum Latency</p>
<p class="p1"><span class="Apple-converted-space">            </span>result = minLat;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if(result &lt; 0.01) result = 0.01;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if(result &gt; 0.5) result = 0.5;</p>
<p class="p1"><span class="Apple-converted-space">            </span>msg = `Latency: ${Math.round(result*1000)}ms&lt;br&gt;Correction Applied.`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>this.latency = result;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const latMs = Math.round(result * 1000);</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.inLat.value = latMs;</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.updateLatDisp(latMs);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>View.showOverlay('result', msg);</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>startGame() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.resetGameUI();</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.running = true; this.stars = 0; this.totalHits = 0; this.beatCount = 0; this.pIndex = 0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.targetQueue = []; this.cycleHits = []; this.noteOn = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.nextTime = AudioSys.ctx.currentTime + 0.1; this.startTime = this.nextTime; this.lastBeatIdx = -1;</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.start.style.display = 'none'; View.els.stop.classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.scheduler(); this.gameLoop();</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>stopGame() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.running = false; View.els.stop.classList.remove('active'); View.els.start.style.display = 'block'; View.els.msg.classList.remove('blink');</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>scheduler() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>while (this.nextTime &lt; AudioSys.ctx.currentTime + 0.1) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.scheduleNote(this.nextTime);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const pat = CONFIG.PATTERNS[this.pattern]; const secs = 60.0 / this.bpm;</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.nextTime += secs * pat[this.pIndex];</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.pIndex++;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (this.pIndex &gt;= pat.length) { this.pIndex = 0; this.beatCount++; this.checkProgress(); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (this.running) setTimeout(() =&gt; this.scheduler(), 25);</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>scheduleNote(time) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const osc = AudioSys.ctx.createOscillator(); const g = AudioSys.ctx.createGain();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const isDown = (this.beatCount % 4 === 0) &amp;&amp; (this.pIndex === 0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.frequency.value = isDown ? 1500 : (this.pIndex === 0 ? 1000 : 600);</p>
<p class="p1"><span class="Apple-converted-space">        </span>g.gain.value = this.vol;</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.connect(g); g.connect(AudioSys.gain);</p>
<p class="p1"><span class="Apple-converted-space">        </span>osc.start(time); osc.stop(time + 0.04);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const pat = CONFIG.PATTERNS[this.pattern]; const dur = (60 / this.bpm) * pat[this.pIndex];</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.targetQueue = this.targetQueue.filter(t =&gt; t.time &gt; AudioSys.ctx.currentTime - 1.0);</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.targetQueue.push({ id: Date.now() + Math.random(), time: time, duration: dur, hit: false });</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>gameLoop() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(this.calibrating) return;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.running) { View.updatePendulum(40); return; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>const now = AudioSys.ctx.currentTime; const rms = AudioSys.getRMS();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const beatDur = 60.0 / this.bpm; const elapsed = now - this.startTime;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(elapsed &gt;= 0) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rad = (elapsed * Math.PI) / beatDur;</p>
<p class="p1"><span class="Apple-converted-space">            </span>View.updatePendulum(Math.cos(rad) * 40);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const curBeat = Math.floor((elapsed + 0.05) / beatDur);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(curBeat &gt; this.lastBeatIdx) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.lastBeatIdx = curBeat;</p>
<p class="p1"><span class="Apple-converted-space">                </span>View.triggerFlash(curBeat % 2 === 0 ? 'R' : 'L');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(rms &gt; this.thresh) { View.updateInputLed(true, false); this.noiseCounter++; }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>else { View.updateInputLed(false, false); this.noiseCounter = 0; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(this.noiseCounter &gt; CONFIG.NOISE_LIMIT) View.updateInputLed(true, true);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.noteOn &amp;&amp; rms &gt; this.thresh) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(now - this.noteStart &gt; 0.05) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.noteOn = true; this.noteStart = now;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(!this.gameActive) { this.gameActive = true; View.els.msg.innerText = "COLLECT 4 STARS"; View.els.msg.classList.remove('blink'); View.els.msg.style.color = "#888"; this.beatCount = 0; }</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.processHit(now);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(this.noteOn &amp;&amp; rms &lt; (this.thresh * 0.6)) { this.noteOn = false; this.processRelease(now); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.drawWave(rms, this.thresh, this.noteOn);</p>
<p class="p1"><span class="Apple-converted-space">        </span>requestAnimationFrame(() =&gt; this.gameLoop());</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>processHit(time) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!this.gameActive) return;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const corrected = time - this.latency;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let best = null; let min = Infinity;</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.targetQueue.forEach(t =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const d = Math.abs(corrected - t.time);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(d &lt; min &amp;&amp; !t.hit) { min = d; best = t; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(best &amp;&amp; min &lt; 0.25) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>best.hit = true; this.lastHitId = best.id; best.actualStart = this.noteStart;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const diffMs = Math.round((corrected - best.time) * 1000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>let judge = "LATE"; if(diffMs &lt; 0) judge = "EARLY";</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(Math.abs(diffMs) &lt;= 45) judge = "PERFECT"; else if(Math.abs(diffMs) &lt;= 100) judge = "GOOD";</p>
<p class="p1"><span class="Apple-converted-space">            </span>View.renderResult('time', (diffMs&gt;0?"+":"")+diffMs, judge); best.lastJudge = judge;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (best &amp;&amp; min &lt; 0.35) { View.renderResult('time', Math.round((corrected - best.time) * 1000), "POOR"); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>processRelease(time) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const t = this.targetQueue.find(q =&gt; q.id === this.lastHitId);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(t &amp;&amp; !t.processed) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const dur = time - t.actualStart; let pct = Math.round((dur / t.duration) * 100);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(pct &gt; 100) pct = 100; if(dur &lt; 0.03) return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>t.processed = true; let judge = "SHORT"; if(pct &gt;= 85) judge = "EXCELLENT"; else if(pct &gt;= 60) judge = "OK";</p>
<p class="p1"><span class="Apple-converted-space">            </span>View.renderResult('legato', pct+"%", judge);</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.cycleHits.push({ t: t.lastDiff, l: pct }); this.totalHits++;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const diffMs = t.lastJudge ? Math.round((t.actualStart - this.latency - t.time) * 1000) : "--";</p>
<p class="p1"><span class="Apple-converted-space">            </span>View.addHistory(this.totalHits, judge, pct, t.lastJudge || "MISS", diffMs);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>checkProgress() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cycle = this.beatCount % 16; const pct = (cycle / 16) * 100;</p>
<p class="p1"><span class="Apple-converted-space">        </span>View.els.bar.style.width = pct + "%";</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(cycle === 0 &amp;&amp; this.beatCount &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const hits = this.cycleHits.length;</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(hits &lt; 4) { View.els.msg.innerText = "PLAY MORE NOTES!"; View.els.msg.style.color = "#666"; }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>let avgL = this.cycleHits.reduce((a,b)=&gt;a+b.l, 0) / hits;</p>
<p class="p1"><span class="Apple-converted-space">                </span>if(avgL &gt;= 75) { this.stars++; View.els.msg.innerText = "GREAT! STAR GET!"; View.els.msg.style.color = "#ffd700"; this.updateStars(); }<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>else { View.els.msg.innerText = `TRY AGAIN (Avg: ${Math.round(avgL)}%)`; View.els.msg.style.color = "#ff3b30"; }</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>this.cycleHits = []; setTimeout(() =&gt; View.els.bar.style.width = "0%", 500);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>},</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateStars() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>for(let i=0; i&lt;4; i++) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if(i &lt; this.stars) View.els.stars[i].classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">            </span>else View.els.stars[i].classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(this.stars &gt;= 4) { this.running = false; this.stopGame(); View.showOverlay('clear'); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">// --- BINDINGS ---</p>
<p class="p1">View.init();</p>
<p class="p1">View.els.inVol.value = Game.vol * 100;</p>
<p class="p1">View.els.inSens.value = Game.thresh * 500;</p>
<p class="p1">View.els.inLat.value = Game.latency * 1000;</p>
<p class="p1">View.updateLatDisp(Math.round(Game.latency * 1000));</p>
<p class="p2"><br></p>
<p class="p1">View.els.inVol.addEventListener('input', e =&gt; { Game.vol = e.target.value/100 || 0.0001; if(AudioSys.gain) AudioSys.gain.gain.value = Game.vol; });</p>
<p class="p1">View.els.inSens.addEventListener('input', e =&gt; Game.thresh = e.target.value/500);</p>
<p class="p1">View.els.inLat.addEventListener('input', e =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>Game.latency = e.target.value/1000;</p>
<p class="p1"><span class="Apple-converted-space">    </span>View.updateLatDisp(e.target.value);</p>
<p class="p1">});</p>
<p class="p1">View.els.inBpm.addEventListener('change', e =&gt; Game.bpm = parseInt(e.target.value));</p>
<p class="p1">View.els.groove.addEventListener('change', e =&gt; { Game.pattern = parseInt(e.target.value); Game.pIndex = 0; });</p>
<p class="p2"><br></p>
<p class="p1">View.els.btnVolMinus.addEventListener('click', () =&gt; { let val = parseInt(View.els.inVol.value)-5; if(val&lt;0)val=0; View.els.inVol.value=val; Game.vol=val/100||0.0001; if(AudioSys.gain)AudioSys.gain.gain.value=Game.vol; });</p>
<p class="p1">View.els.btnVolPlus.addEventListener('click', () =&gt; { let val = parseInt(View.els.inVol.value)+5; if(val&gt;100)val=100; View.els.inVol.value=val; Game.vol=val/100; if(AudioSys.gain)AudioSys.gain.gain.value=Game.vol; });</p>
<p class="p1">View.els.btnSensMinus.addEventListener('click', () =&gt; { let val = parseInt(View.els.inSens.value)-1; if(val&lt;1)val=1; View.els.inSens.value=val; Game.thresh=val/500; });</p>
<p class="p1">View.els.btnSensPlus.addEventListener('click', () =&gt; { let val = parseInt(View.els.inSens.value)+1; if(val&gt;50)val=50; View.els.inSens.value=val; Game.thresh=val/500; });</p>
<p class="p1">View.els.btnLatMinus.addEventListener('click', () =&gt; {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>let val = parseInt(View.els.inLat.value)-5; if(val&lt;0)val=0;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>View.els.inLat.value=val; View.updateLatDisp(val); Game.latency=val/1000;<span class="Apple-converted-space"> </span></p>
<p class="p1">});</p>
<p class="p1">View.els.btnLatPlus.addEventListener('click', () =&gt; {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>let val = parseInt(View.els.inLat.value)+5; if(val&gt;400)val=400;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>View.els.inLat.value=val; View.updateLatDisp(val); Game.latency=val/1000;<span class="Apple-converted-space"> </span></p>
<p class="p1">});</p>
<p class="p2"><br></p>
<p class="p1">View.els.calibBtn.addEventListener('click', e =&gt; Game.startCalibration(e));</p>
<p class="p1">View.els.skipLink.addEventListener('click', async e =&gt; { e.stopPropagation(); const ready = await AudioSys.init(); if(ready) { View.els.overlay.style.display = 'none'; Game.startGame(); }});</p>
<p class="p1">View.els.start.addEventListener('click', async () =&gt; { const ready = await AudioSys.init(); if(ready) Game.startGame(); });</p>
<p class="p1">View.els.stop.addEventListener('click', () =&gt; Game.stopGame());</p>
<p class="p1">View.els.restartBtn.addEventListener('click', (e) =&gt; {<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>e.stopPropagation(); View.els.overlay.style.display = 'none';<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if(View.els.restartBtn.innerText === "START GAME") Game.startGame();</p>
<p class="p1"><span class="Apple-converted-space">    </span>else View.resetGameUI();<span class="Apple-converted-space"> </span></p>
<p class="p1">});</p>
<p class="p1">document.getElementById('btnReCalib').addEventListener('click', () =&gt; { Game.stopGame(); View.showOverlay('calib'); });</p>
<p class="p1">document.getElementById('btnCloseOverlay').addEventListener('click', (e) =&gt; { e.stopPropagation(); View.els.overlay.style.display = 'none'; Game.calibrating = false; View.resetGameUI(); });</p>
<p class="p1">View.els.overlay.addEventListener('click', e =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(Game.calibrating) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(e.target.tagName === "BUTTON") return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(View.els.restartBtn.style.display === 'block') { View.els.overlay.style.display = 'none'; View.resetGameUI(); }</p>
<p class="p1">});</p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
